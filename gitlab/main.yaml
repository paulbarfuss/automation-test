---
- name: Test Git Checkout
  hosts: all

  environment:
    GIT_SSH: ssh -o StrictHostKeyChecking=no -i /var/lib/awx/.ssh/deploy.key

  tasks:
    - name: Set fact
      set_fact:
        url: "{{ tower_webhook_payload.project.git_ssh_url }}"
        directory: "{{ playbook_dir }}/{{ tower_webhook_payload.project.id }}"

    - name: Move ssh key into place
      copy:
        src: "{{ gitlab_ssh_private_key_file }}"
        dest: "/var/lib/awx/.ssh/deploy.key"

    - name: Create gitlab project directory
      file:
        path: "{{ directory }}"
        state: directory
        mode: '0775'

    - name: Git clone
      shell: "git clone {{ url }} {{ directory }}"

    - name: Set engagement_data var
      set_fact:
        engagement_data: "{{ lookup('file', (directory + '/iac/engagement.json') | from_json }}"

    - name: Print engagement data
      debug:
        var: engagement_data
        
