---
- name: Create new inventory
  hosts: all

  tasks:
    - name: Set fact
      set_fact:
        url: "{{ tower_webhook_payload.project.git_ssh_url }}"
        directory: "/tmp/git_projects/{{ tower_webhook_payload.project.id }}"
        project: "{{ tower_webhook_payload.project.ssh_url }}"

    - name: Create gitlab project directory
      file:
        path: "{{ directory }}"
        state: directory
        mode: '0775'

    - name: Git clone engagement repository
      git:
        repo: "{{ url }}"
        dest: "{{ directory }}"
        ssh_opts: "-o StrictHostKeyChecking=no"
        force: true
        key_file: /var/lib/awx/.ssh/bridge-private-key

    - name: Set engagement_data var
      set_fact:
        engagement_data: "{{ lookup('file', directory + '/engagement.json') | from_json }}"

    - name: Set facts
      set_fact:
        cacheable: true
        delete_missing_items: false
        ansible_tower:
          url: "{{ ansible_tower_url }}"
          admin_username: "{{ ansible_tower_admin_username }}"
          admin_password: "{{ ansible_tower_admin_password }}"
          projects:
            - name: "{{ project_namespace }} Project"
              description: "My Project"
              scm_type: "git"
              scm_url: "{{ tower_webhook_payload.project.ssh_url }}"
              scm_branch: "{{ tower_webhook_payload.project.default_branch }}"
              scm_credential_name: "test_deploy_key"
              scm_update_on_launch: true
              organization: "lodestar"
          inventories:
            - name: "{{ project_namespace }} Inventory"
              variables: "{{ engagement_data }}"
              organization: "lodestar"
              hosts:
                - name: "localhost"
                  variables: |-
                    ---
                    ansible_connection: local
              sources:
                - name: "{{ project_namespace }} Source"
                  credential: "test_deploy_key"
                  source: "scm"
                  source_project: "{{ project_namespace }} Project"
                  source_path: "/"
                  source_vars: ""

    - name: Print ansible_tower vars
      debug:
        var: ansible_tower

- name: Create inventory with infra-ansible
  import_playbook: ./requirements_roles/infra-ansible/playbooks/ansible/tower/configure-ansible-tower.yml
  vars:
    users: "{{ ansible_tower }}"
